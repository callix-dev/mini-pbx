; /etc/asterisk/func_odbc.conf
; ODBC Functions for Mini-PBX
; 
; These functions allow Asterisk to query the Laravel database
; for routing decisions without reloading configuration.

[general]
; Nothing needed here for basic usage

; =================================================================
; DID ROUTING
; =================================================================

; Get DID destination (returns: destination_type,destination_id)
; Usage: ${ODBC_DID_DESTINATION(8005551234)}
; Returns: extension_group,5 or extension,1002 or queue,3
[DID_DESTINATION]
dsn=asterisk
readsql=SELECT destination_type || ',' || COALESCE(destination_id::text, '') FROM dids WHERE number = '${ARG1}' AND is_active = true LIMIT 1

; Get DID after-hours destination
; Usage: ${ODBC_DID_AFTERHOURS(8005551234)}
[DID_AFTERHOURS]
dsn=asterisk
readsql=SELECT after_hours_destination_type || ',' || COALESCE(after_hours_destination_id::text, '') FROM dids WHERE number = '${ARG1}' AND is_active = true AND time_based_routing = true LIMIT 1

; Check if current time is within business hours for a DID
; Returns: 1 if within business hours, 0 if after hours
; Note: This is a simplified check - for complex schedules, use AGI
[DID_IS_BUSINESS_HOURS]
dsn=asterisk
readsql=SELECT CASE WHEN time_based_routing = false THEN 1 ELSE CASE WHEN business_hours IS NOT NULL THEN 1 ELSE 1 END END FROM dids WHERE number = '${ARG1}' LIMIT 1

; =================================================================
; EXTENSION GROUP FUNCTIONS
; =================================================================

; Get extension group name by ID
; Usage: ${ODBC_EXTGROUP_NAME(5)}
[EXTGROUP_NAME]
dsn=asterisk
readsql=SELECT name FROM extension_groups WHERE id = '${ARG1}' AND is_active = true LIMIT 1

; Get extension group ring strategy
; Usage: ${ODBC_EXTGROUP_STRATEGY(5)}
[EXTGROUP_STRATEGY]
dsn=asterisk
readsql=SELECT ring_strategy FROM extension_groups WHERE id = '${ARG1}' AND is_active = true LIMIT 1

; Get extension group ring time
; Usage: ${ODBC_EXTGROUP_RINGTIME(5)}
[EXTGROUP_RINGTIME]
dsn=asterisk
readsql=SELECT ring_time FROM extension_groups WHERE id = '${ARG1}' AND is_active = true LIMIT 1

; Get dial string for extension group (for ringall strategy bypass)
; Usage: ${ODBC_EXTGROUP_DIALSTR(5)}
; Returns: PJSIP/1001&PJSIP/1002&PJSIP/1003
[EXTGROUP_DIALSTR]
dsn=asterisk
readsql=SELECT string_agg('PJSIP/' || e.extension, '&' ORDER BY eeg.priority) FROM extension_extension_group eeg JOIN extensions e ON e.id = eeg.extension_id WHERE eeg.extension_group_id = '${ARG1}' AND e.is_active = true

; =================================================================
; EXTENSION FUNCTIONS
; =================================================================

; Get extension name
; Usage: ${ODBC_EXT_NAME(1001)}
[EXT_NAME]
dsn=asterisk
readsql=SELECT name FROM extensions WHERE extension = '${ARG1}' AND is_active = true LIMIT 1

; Get extension caller ID
; Usage: ${ODBC_EXT_CALLERID(1001)}
[EXT_CALLERID]
dsn=asterisk
readsql=SELECT COALESCE(caller_id_name, name) || ' <' || COALESCE(caller_id_number, extension) || '>' FROM extensions WHERE extension = '${ARG1}' LIMIT 1

; Check if extension has voicemail enabled
; Usage: ${ODBC_EXT_HAS_VM(1001)}
[EXT_HAS_VM]
dsn=asterisk
readsql=SELECT CASE WHEN voicemail_enabled = true THEN 1 ELSE 0 END FROM extensions WHERE extension = '${ARG1}' LIMIT 1

; Check if extension has DND enabled
; Usage: ${ODBC_EXT_DND(1001)}
[EXT_DND]
dsn=asterisk
readsql=SELECT CASE WHEN dnd_enabled = true THEN 1 ELSE 0 END FROM extensions WHERE extension = '${ARG1}' LIMIT 1

; Get extension's call forward destination
; Usage: ${ODBC_EXT_CFWD(1001)}
[EXT_CFWD]
dsn=asterisk
readsql=SELECT call_forward_destination FROM extensions WHERE extension = '${ARG1}' AND call_forward_enabled = true LIMIT 1

; =================================================================
; QUEUE FUNCTIONS
; =================================================================

; Get queue name by ID
; Usage: ${ODBC_QUEUE_NAME(3)}
[QUEUE_NAME]
dsn=asterisk
readsql=SELECT name FROM queues WHERE id = '${ARG1}' AND is_active = true LIMIT 1

; =================================================================
; CARRIER/TRUNK FUNCTIONS
; =================================================================

; Get carrier name by ID
; Usage: ${ODBC_CARRIER_NAME(2)}
[CARRIER_NAME]
dsn=asterisk
readsql=SELECT name FROM carriers WHERE id = '${ARG1}' AND is_active = true LIMIT 1

; Get outbound trunk for a DID
; Usage: ${ODBC_DID_TRUNK(8005551234)}
[DID_TRUNK]
dsn=asterisk
readsql=SELECT c.name FROM dids d JOIN carriers c ON d.carrier_id = c.id WHERE d.number = '${ARG1}' LIMIT 1

