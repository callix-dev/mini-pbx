; /etc/asterisk/extensions.conf
; Dialplan configuration for Mini-PBX

[general]
static=yes
writeprotect=no
autofallthrough=yes
clearglobalvars=no
priorityjumping=no

; =================================================================
; GLOBAL VARIABLES
; =================================================================
[globals]
TRUNK=my-provider
OPERATOR=1000
VOICEMAIL_CONTEXT=default
RECORD_CALLS=yes
MOH_CLASS=default

; =================================================================
; INTERNAL CONTEXT - Calls from registered extensions
; =================================================================
[from-internal]
; Emergency services (adjust for your country)
exten => 911,1,NoOp(Emergency Call)
 same => n,Dial(PJSIP/${TRUNK}/911)
 same => n,Hangup()

; Feature codes
include => features

; Internal extension dialing (3-4 digit extensions)
exten => _1XXX,1,NoOp(Internal Call to ${EXTEN})
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Set(__RECORDING=${IF(${RECORD_CALLS}?MixMonitor(${UNIQUEID}.wav,ab):NoOp())})
 same => n,Dial(PJSIP/${EXTEN},30,tTkK)
 same => n,Goto(voicemail,s-${DIALSTATUS},1)

; Outbound calls - 10 digit
exten => _NXXNXXXXXX,1,NoOp(Outbound Call to ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK},60,tT)
 same => n,Hangup()

; Outbound calls - 11 digit (1 + 10 digit)
exten => _1NXXNXXXXXX,1,NoOp(Outbound Call to ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK},60,tT)
 same => n,Hangup()

; Outbound calls - International
exten => _011.,1,NoOp(International Call to ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK},60,tT)
 same => n,Hangup()

; Invalid extension
exten => i,1,Playback(pbx-invalid)
 same => n,Hangup()

; =================================================================
; FEATURE CODES
; =================================================================
[features]
; Voicemail - check own
exten => *97,1,NoOp(Voicemail - Check Own)
 same => n,VoiceMailMain(${CALLERID(num)}@${VOICEMAIL_CONTEXT},s)
 same => n,Hangup()

; Voicemail - direct
exten => *98,1,NoOp(Voicemail - Direct Access)
 same => n,VoiceMailMain(@${VOICEMAIL_CONTEXT})
 same => n,Hangup()

; Echo test
exten => *43,1,NoOp(Echo Test)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; Speaking clock
exten => *60,1,NoOp(Speaking Clock)
 same => n,Answer()
 same => n,SayUnixTime(,,%A %B %e %Y %I %M %p)
 same => n,Hangup()

; Call pickup
exten => *8,1,NoOp(Call Pickup)
 same => n,Pickup()
 same => n,Hangup()

; Directed pickup
exten => **,1,NoOp(Directed Pickup)
 same => n,Read(PICKUP_EXT,dial-extn,4)
 same => n,Pickup(${PICKUP_EXT}@PICKUPMARK)
 same => n,Hangup()

; Call parking
exten => #72,1,NoOp(Park Call)
 same => n,Park(default,sc(parked,10,1))
 same => n,Hangup()

; DND toggle
exten => *78,1,NoOp(DND Toggle)
 same => n,Set(DB(DND/${CALLERID(num)})=${IF($[${DB_EXISTS(DND/${CALLERID(num)})}]?:1)})
 same => n,Playback(${IF($[${DB(DND/${CALLERID(num)})}]?do-not-disturb:do-not-disturb-deactivated)})
 same => n,Hangup()

; Agent login
exten => *45,1,NoOp(Agent Login)
 same => n,AddQueueMember(default,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-loginok)
 same => n,Hangup()

; Agent logout
exten => *46,1,NoOp(Agent Logout)
 same => n,RemoveQueueMember(default,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-loggedoff)
 same => n,Hangup()

; Agent pause
exten => *47,1,NoOp(Agent Pause)
 same => n,PauseQueueMember(,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-pause)
 same => n,Hangup()

; Agent unpause
exten => *48,1,NoOp(Agent Unpause)
 same => n,UnpauseQueueMember(,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-pause)
 same => n,Hangup()

; =================================================================
; INBOUND FROM TRUNK
; =================================================================
[from-trunk]
exten => _X.,1,NoOp(Inbound Call from ${CALLERID(num)} to ${EXTEN})
 same => n,Set(__RECORDING=${IF(${RECORD_CALLS}?MixMonitor(${UNIQUEID}.wav,ab):NoOp())})
 same => n,Goto(inbound-handler,${EXTEN},1)

[inbound-handler]
; Match DID to route
; You would typically use a database lookup here
; This is a simple example routing all to a queue or extension

exten => _X.,1,NoOp(DID Handler for ${EXTEN})
 same => n,Answer()
 same => n,Wait(1)
 ; Route to main queue or IVR
 same => n,Goto(queues,main-queue,1)

; Default
exten => s,1,NoOp(Default Inbound)
 same => n,Answer()
 same => n,Goto(queues,main-queue,1)

; =================================================================
; QUEUES
; =================================================================
[queues]
exten => main-queue,1,NoOp(Main Queue)
 same => n,Answer()
 same => n,Set(CHANNEL(musicclass)=${MOH_CLASS})
 same => n,Queue(default,tT,,,300)
 same => n,Voicemail(${OPERATOR}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

; =================================================================
; VOICEMAIL HANDLING
; =================================================================
[voicemail]
exten => s-NOANSWER,1,Voicemail(${MACRO_EXTEN}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

exten => s-BUSY,1,Voicemail(${MACRO_EXTEN}@${VOICEMAIL_CONTEXT},b)
 same => n,Hangup()

exten => s-CHANUNAVAIL,1,Voicemail(${MACRO_EXTEN}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

exten => s-CONGESTION,1,Voicemail(${MACRO_EXTEN}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

exten => s-,1,Goto(s-NOANSWER,1)

; =================================================================
; PARKING
; =================================================================
[parked]
exten => 700,1,NoOp(Parking Lot Access)
 same => n,Park(default)
 same => n,Hangup()

exten => _70X,1,NoOp(Retrieve Parked Call)
 same => n,ParkedCall(default,${EXTEN})
 same => n,Hangup()

; =================================================================
; EXTERNAL (ANONYMOUS)
; =================================================================
[from-external]
; Handle anonymous/external calls
exten => _X.,1,NoOp(External Call to ${EXTEN})
 same => n,Goto(from-trunk,${EXTEN},1)

; =================================================================
; HANGUP HANDLER
; =================================================================
[hangup-handler]
exten => s,1,NoOp(Hangup Handler)
 same => n,Return()



