; /etc/asterisk/extensions.conf
; Dialplan configuration for Mini-PBX

[general]
static=yes
writeprotect=no
autofallthrough=yes
clearglobalvars=no
priorityjumping=no

; =================================================================
; GLOBAL VARIABLES
; =================================================================
[globals]
TRUNK=my-provider
OPERATOR=1000
VOICEMAIL_CONTEXT=default
RECORD_CALLS=yes
MOH_CLASS=default

; =================================================================
; INTERNAL CONTEXT - Calls from registered extensions
; =================================================================
[from-internal]
; Emergency services (adjust for your country)
exten => 911,1,NoOp(Emergency Call)
 same => n,Dial(PJSIP/${TRUNK}/911)
 same => n,Hangup()

; Feature codes
include => features

; Internal extension dialing (3-4 digit extensions)
exten => _1XXX,1,NoOp(Internal Call to ${EXTEN})
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Set(__RECORDING=${IF(${RECORD_CALLS}?MixMonitor(${UNIQUEID}.wav,ab):NoOp())})
 same => n,Dial(PJSIP/${EXTEN},30,tTkK)
 same => n,Goto(voicemail,s-${DIALSTATUS},1)

; Outbound calls - 10 digit
exten => _NXXNXXXXXX,1,NoOp(Outbound Call to ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK},60,tT)
 same => n,Hangup()

; Outbound calls - 11 digit (1 + 10 digit)
exten => _1NXXNXXXXXX,1,NoOp(Outbound Call to ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK},60,tT)
 same => n,Hangup()

; Outbound calls - International
exten => _011.,1,NoOp(International Call to ${EXTEN})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK},60,tT)
 same => n,Hangup()

; Invalid extension
exten => i,1,Playback(pbx-invalid)
 same => n,Hangup()

; =================================================================
; FEATURE CODES
; =================================================================
[features]
; Voicemail - check own
exten => *97,1,NoOp(Voicemail - Check Own)
 same => n,VoiceMailMain(${CALLERID(num)}@${VOICEMAIL_CONTEXT},s)
 same => n,Hangup()

; Voicemail - direct
exten => *98,1,NoOp(Voicemail - Direct Access)
 same => n,VoiceMailMain(@${VOICEMAIL_CONTEXT})
 same => n,Hangup()

; Echo test
exten => *43,1,NoOp(Echo Test)
 same => n,Answer()
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; Speaking clock
exten => *60,1,NoOp(Speaking Clock)
 same => n,Answer()
 same => n,SayUnixTime(,,%A %B %e %Y %I %M %p)
 same => n,Hangup()

; Call pickup
exten => *8,1,NoOp(Call Pickup)
 same => n,Pickup()
 same => n,Hangup()

; Directed pickup
exten => **,1,NoOp(Directed Pickup)
 same => n,Read(PICKUP_EXT,dial-extn,4)
 same => n,Pickup(${PICKUP_EXT}@PICKUPMARK)
 same => n,Hangup()

; Call parking
exten => #72,1,NoOp(Park Call)
 same => n,Park(default,sc(parked,10,1))
 same => n,Hangup()

; DND toggle
exten => *78,1,NoOp(DND Toggle)
 same => n,Set(DB(DND/${CALLERID(num)})=${IF($[${DB_EXISTS(DND/${CALLERID(num)})}]?:1)})
 same => n,Playback(${IF($[${DB(DND/${CALLERID(num)})}]?do-not-disturb:do-not-disturb-deactivated)})
 same => n,Hangup()

; Agent login
exten => *45,1,NoOp(Agent Login)
 same => n,AddQueueMember(default,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-loginok)
 same => n,Hangup()

; Agent logout
exten => *46,1,NoOp(Agent Logout)
 same => n,RemoveQueueMember(default,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-loggedoff)
 same => n,Hangup()

; Agent pause
exten => *47,1,NoOp(Agent Pause)
 same => n,PauseQueueMember(,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-pause)
 same => n,Hangup()

; Agent unpause
exten => *48,1,NoOp(Agent Unpause)
 same => n,UnpauseQueueMember(,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-pause)
 same => n,Hangup()

; =================================================================
; INBOUND FROM TRUNK
; =================================================================
[from-trunk]
exten => _X.,1,NoOp(Inbound Call from ${CALLERID(num)} to ${EXTEN})
 same => n,Set(__DID=${EXTEN})
 same => n,Set(__RECORDING=${IF(${RECORD_CALLS}?MixMonitor(${STRFTIME(${EPOCH},,%Y/%m/%d)}/${UNIQUEID}.wav,ab):NoOp())})
 same => n,Goto(inbound-handler,${EXTEN},1)

; =================================================================
; INBOUND HANDLER - Routes calls based on DID configuration
; Uses FUNC_ODBC to query the database for routing
; =================================================================
[inbound-handler]
; Route DID to its configured destination
exten => _X.,1,NoOp(DID Handler for ${EXTEN})
 same => n,Set(DEST=${ODBC_DID_DESTINATION(${EXTEN})})
 same => n,NoOp(DID Destination: ${DEST})
 same => n,GotoIf($["${DEST}" = ""]?no-route,s,1)
 same => n,Set(DEST_TYPE=${CUT(DEST,\,,1)})
 same => n,Set(DEST_ID=${CUT(DEST,\,,2)})
 same => n,NoOp(Routing to ${DEST_TYPE} ID ${DEST_ID})
 ; Route based on destination type
 same => n,GotoIf($["${DEST_TYPE}" = "extension_group"]?extgroup-handler,${DEST_ID},1)
 same => n,GotoIf($["${DEST_TYPE}" = "extension"]?dial-extension,${DEST_ID},1)
 same => n,GotoIf($["${DEST_TYPE}" = "queue"]?dial-queue,${DEST_ID},1)
 same => n,GotoIf($["${DEST_TYPE}" = "ivr"]?dial-ivr,${DEST_ID},1)
 same => n,GotoIf($["${DEST_TYPE}" = "voicemail"]?dial-voicemail,${DEST_ID},1)
 same => n,GotoIf($["${DEST_TYPE}" = "external"]?dial-external,${DEST_ID},1)
 same => n,GotoIf($["${DEST_TYPE}" = "ring_tree"]?dial-ringtree,${DEST_ID},1)
 same => n,Goto(no-route,s,1)

; Default/fallback
exten => s,1,NoOp(Default Inbound - No DID match)
 same => n,Goto(no-route,s,1)

; =================================================================
; EXTENSION GROUP HANDLER
; Routes to Asterisk Queue (extgroup_X) which handles ring strategies
; =================================================================
[extgroup-handler]
exten => _X,1,NoOp(Extension Group ${EXTEN})
 same => n,Set(QUEUE_NAME=extgroup_${EXTEN})
 same => n,Set(GROUP_NAME=${ODBC_EXTGROUP_NAME(${EXTEN})})
 same => n,NoOp(Routing to queue ${QUEUE_NAME} - ${GROUP_NAME})
 same => n,Answer()
 same => n,Set(CHANNEL(musicclass)=${MOH_CLASS})
 ; Queue options: t=allow transfer, T=allow caller transfer, k=parking, K=caller parking
 ; Timeout is handled by the queue configuration (ring_time)
 same => n,Queue(${QUEUE_NAME},tTkK,,,300)
 same => n,NoOp(Queue returned with status ${QUEUESTATUS})
 same => n,GotoIf($["${QUEUESTATUS}" = "TIMEOUT"]?timeout)
 same => n,GotoIf($["${QUEUESTATUS}" = "FULL"]?full)
 same => n,GotoIf($["${QUEUESTATUS}" = "JOINEMPTY"]?empty)
 same => n,GotoIf($["${QUEUESTATUS}" = "LEAVEEMPTY"]?empty)
 same => n,GotoIf($["${QUEUESTATUS}" = "JOINUNAVAIL"]?unavail)
 same => n,GotoIf($["${QUEUESTATUS}" = "LEAVEUNAVAIL"]?unavail)
 same => n,Hangup()
 same => n(timeout),NoOp(Queue timeout - sending to voicemail)
 same => n,Goto(voicemail,s-NOANSWER,1)
 same => n(full),NoOp(Queue full)
 same => n,Playback(all-circuits-busy-now)
 same => n,Hangup()
 same => n(empty),NoOp(Queue empty - no agents)
 same => n,Playback(all-circuits-busy-now)
 same => n,Hangup()
 same => n(unavail),NoOp(Queue unavailable)
 same => n,Playback(all-circuits-busy-now)
 same => n,Hangup()

; =================================================================
; DIAL EXTENSION
; =================================================================
[dial-extension]
exten => _X.,1,NoOp(Dialing Extension ${EXTEN})
 same => n,Set(EXT_NAME=${ODBC_EXT_NAME(${EXTEN})})
 same => n,NoOp(Extension: ${EXTEN} - ${EXT_NAME})
 ; Check for call forward
 same => n,Set(CFWD=${ODBC_EXT_CFWD(${EXTEN})})
 same => n,GotoIf($["${CFWD}" != ""]?forward)
 ; Check for DND
 same => n,Set(DND=${ODBC_EXT_DND(${EXTEN})})
 same => n,GotoIf($["${DND}" = "1"]?dnd)
 ; Dial the extension
 same => n,Dial(PJSIP/${EXTEN},30,tTkK)
 same => n,NoOp(Dial returned: ${DIALSTATUS})
 same => n,GotoIf($["${DIALSTATUS}" = "BUSY"]?busy)
 same => n,GotoIf($["${DIALSTATUS}" = "NOANSWER"]?noanswer)
 same => n,GotoIf($["${DIALSTATUS}" = "CHANUNAVAIL"]?unavail)
 same => n,Hangup()
 same => n(forward),NoOp(Call forward to ${CFWD})
 same => n,Dial(PJSIP/${CFWD},30,tTkK)
 same => n,Hangup()
 same => n(dnd),NoOp(Extension has DND enabled)
 same => n,Goto(voicemail,s-BUSY,1)
 same => n(busy),Goto(voicemail,s-BUSY,1)
 same => n(noanswer),Goto(voicemail,s-NOANSWER,1)
 same => n(unavail),Goto(voicemail,s-CHANUNAVAIL,1)

; =================================================================
; DIAL QUEUE (standard queues, not extension groups)
; =================================================================
[dial-queue]
exten => _X,1,NoOp(Dialing Queue ID ${EXTEN})
 same => n,Set(QUEUE_NAME=${ODBC_QUEUE_NAME(${EXTEN})})
 same => n,GotoIf($["${QUEUE_NAME}" = ""]?no-route,s,1)
 same => n,Answer()
 same => n,Set(CHANNEL(musicclass)=${MOH_CLASS})
 same => n,Queue(${QUEUE_NAME},tTkK,,,300)
 same => n,Hangup()

; =================================================================
; DIAL IVR
; =================================================================
[dial-ivr]
exten => _X,1,NoOp(IVR ${EXTEN})
 same => n,Answer()
 ; IVR handling would go here - typically uses Goto to IVR context
 same => n,Playback(invalid)
 same => n,Hangup()

; =================================================================
; DIAL VOICEMAIL
; =================================================================
[dial-voicemail]
exten => _X.,1,NoOp(Direct to Voicemail ${EXTEN})
 same => n,Answer()
 same => n,VoiceMail(${EXTEN}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

; =================================================================
; DIAL EXTERNAL NUMBER
; =================================================================
[dial-external]
exten => _X.,1,NoOp(External Forward to ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN}@${TRUNK},60,tT)
 same => n,Hangup()

; =================================================================
; DIAL RING TREE
; =================================================================
[dial-ringtree]
exten => _X,1,NoOp(Ring Tree ${EXTEN})
 ; Ring trees need custom logic - typically handled by AGI or Gosub
 same => n,Playback(invalid)
 same => n,Hangup()

; =================================================================
; NO ROUTE FOUND
; =================================================================
[no-route]
exten => s,1,NoOp(No route found for DID ${DID})
 same => n,Answer()
 same => n,Playback(ss-noservice)
 same => n,Wait(2)
 same => n,Hangup()

; =================================================================
; QUEUES (legacy static queues)
; =================================================================
[queues]
exten => main-queue,1,NoOp(Main Queue)
 same => n,Answer()
 same => n,Set(CHANNEL(musicclass)=${MOH_CLASS})
 same => n,Queue(default,tT,,,300)
 same => n,Voicemail(${OPERATOR}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

; =================================================================
; VOICEMAIL HANDLING
; =================================================================
[voicemail]
exten => s-NOANSWER,1,Voicemail(${MACRO_EXTEN}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

exten => s-BUSY,1,Voicemail(${MACRO_EXTEN}@${VOICEMAIL_CONTEXT},b)
 same => n,Hangup()

exten => s-CHANUNAVAIL,1,Voicemail(${MACRO_EXTEN}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

exten => s-CONGESTION,1,Voicemail(${MACRO_EXTEN}@${VOICEMAIL_CONTEXT},u)
 same => n,Hangup()

exten => s-,1,Goto(s-NOANSWER,1)

; =================================================================
; PARKING
; =================================================================
[parked]
exten => 700,1,NoOp(Parking Lot Access)
 same => n,Park(default)
 same => n,Hangup()

exten => _70X,1,NoOp(Retrieve Parked Call)
 same => n,ParkedCall(default,${EXTEN})
 same => n,Hangup()

; =================================================================
; EXTERNAL (ANONYMOUS)
; =================================================================
[from-external]
; Handle anonymous/external calls
exten => _X.,1,NoOp(External Call to ${EXTEN})
 same => n,Goto(from-trunk,${EXTEN},1)

; =================================================================
; HANGUP HANDLER
; =================================================================
[hangup-handler]
exten => s,1,NoOp(Hangup Handler)
 same => n,Return()





