; =================================================================
; SIP SECURITY DIALPLAN ADDITIONS
; =================================================================
; This file contains the security-enhanced dialplan for DID validation
; and call logging. Merge this into /etc/asterisk/extensions.conf
;
; Features:
; - Validates all inbound calls against registered DIDs
; - Logs all SIP events to database and file
; - Rejects unauthorized calls with congestion
; =================================================================

; =================================================================
; INBOUND FROM TRUNK (CARRIERS) - SECURITY ENABLED
; =================================================================
[from-trunk]
; All inbound calls go through security validation
; Pattern _. matches any extension (letters or numbers)

exten => _.,1,NoOp(=== INBOUND CALL START ===)
 same => n,NoOp(Caller: ${CALLERID(all)})
 same => n,NoOp(Called: ${EXTEN})
 same => n,NoOp(Channel: ${CHANNEL})
 
 ; Get source IP and port from PJSIP channel
 same => n,Set(SRC_ADDR=${CHANNEL(pjsip,remote_addr)})
 same => n,Set(SRC_IP=${CUT(SRC_ADDR,:,1)})
 same => n,Set(SRC_PORT=${CUT(SRC_ADDR,:,2)})
 same => n,Set(ENDPOINT=${CHANNEL(endpoint)})
 
 same => n,NoOp(Source: ${SRC_IP}:${SRC_PORT} via ${ENDPOINT})
 
 ; Run security AGI - validates DID and logs event
 same => n,AGI(sip_security.php,inbound,${EXTEN},${CALLERID(num)})
 
 ; Check if DID is valid
 same => n,NoOp(DID Valid: ${DID_VALID}, Status: ${SIP_LOG_STATUS})
 same => n,GotoIf($["${DID_VALID}" = "1"]?valid:invalid)
 
 ; Invalid DID - reject with congestion
 same => n(invalid),NoOp(REJECTED: DID ${EXTEN} not registered)
 same => n,Congestion(5)
 same => n,Hangup(21) ; Call rejected (21 = USER_BUSY or similar)
 
 ; Valid DID - proceed with recording and routing
 same => n(valid),NoOp(ALLOWED: Routing to ${DID_DESTINATION_TYPE}:${DID_DESTINATION_ID})
 same => n,Set(__RECORDING=${UNIQUEID}.wav)
 same => n,MixMonitor(/var/spool/asterisk/monitor/${RECORDING},ab)
 same => n,Set(CDR(userfield)=${RECORDING})
 same => n,Goto(route-inbound,${EXTEN},1)

; Handler for Vonage-style extensions (VH...)
exten => _VH.,1,Goto(from-trunk,${EXTEN},1)


; =================================================================
; INBOUND ROUTING
; =================================================================
[route-inbound]
; Route validated calls to their destinations

exten => _.,1,NoOp(Route Inbound: ${EXTEN})
 same => n,NoOp(Destination Type: ${DID_DESTINATION_TYPE})
 same => n,NoOp(Destination ID: ${DID_DESTINATION_ID})
 
 ; Route based on destination type
 same => n,GotoIf($["${DID_DESTINATION_TYPE}" = "extension"]?route-extension,${DID_DESTINATION_ID},1)
 same => n,GotoIf($["${DID_DESTINATION_TYPE}" = "extension_group"]?extgroup-handler,${DID_DESTINATION_ID},1)
 same => n,GotoIf($["${DID_DESTINATION_TYPE}" = "queue"]?route-queue,${DID_DESTINATION_ID},1)
 same => n,GotoIf($["${DID_DESTINATION_TYPE}" = "ivr"]?route-ivr,${DID_DESTINATION_ID},1)
 same => n,GotoIf($["${DID_DESTINATION_TYPE}" = "ring_tree"]?route-ringtree,${DID_DESTINATION_ID},1)
 same => n,GotoIf($["${DID_DESTINATION_TYPE}" = "voicemail"]?route-voicemail,${DID_DESTINATION_ID},1)
 same => n,GotoIf($["${DID_DESTINATION_TYPE}" = "external"]?route-external,${DID_DESTINATION_ID},1)
 
 ; Fallback - no destination type set, try default handling
 same => n,NoOp(No destination type - using fallback)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(hello-world)
 same => n,Hangup()

; Vonage-style extension handler
exten => _VH.,1,Goto(route-inbound,${EXTEN},1)


; =================================================================
; OUTBOUND TO TRUNK - WITH LOGGING
; =================================================================
[to-trunk]
; Outbound calls through carriers

exten => _X.,1,NoOp(=== OUTBOUND CALL START ===)
 same => n,NoOp(Caller: ${CALLERID(all)})
 same => n,NoOp(Destination: ${EXTEN})
 
 ; Log outbound call via AGI
 same => n,AGI(sip_security.php,outbound,${EXTEN},${CALLERID(num)})
 
 ; Set up recording
 same => n,Set(__RECORDING=${UNIQUEID}.wav)
 same => n,MixMonitor(/var/spool/asterisk/monitor/${RECORDING},ab)
 same => n,Set(CDR(userfield)=${RECORDING})
 
 ; Dial via trunk
 same => n,Dial(PJSIP/${TRUNK}/${EXTEN},60,tT)
 same => n,NoOp(Call result: ${DIALSTATUS})
 same => n,Hangup()


; =================================================================
; DESTINATION HANDLERS
; =================================================================
[route-extension]
exten => _X,1,NoOp(Routing to Extension ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30,tTkK)
 same => n,Goto(voicemail-fallback,${EXTEN},1)

[route-queue]
exten => _X,1,NoOp(Routing to Queue ${EXTEN})
 same => n,Answer()
 same => n,Queue(${EXTEN},tTkK,,,300)
 same => n,Hangup()

[route-ivr]
exten => _X,1,NoOp(Routing to IVR ${EXTEN})
 same => n,Goto(ivr-${EXTEN},s,1)

[route-ringtree]
exten => _X,1,NoOp(Routing to Ring Tree ${EXTEN})
 same => n,Goto(ringtree-${EXTEN},s,1)

[route-voicemail]
exten => _X,1,NoOp(Routing to Voicemail ${EXTEN})
 same => n,Answer()
 same => n,VoiceMail(${EXTEN},u)
 same => n,Hangup()

[route-external]
exten => _X.,1,NoOp(Routing to External ${EXTEN})
 same => n,Goto(to-trunk,${EXTEN},1)

[voicemail-fallback]
exten => _X,1,NoOp(Voicemail Fallback for ${EXTEN})
 same => n,VoiceMail(${EXTEN},u)
 same => n,Hangup()

[extgroup-handler]
exten => _X,1,NoOp(Extension Group ${EXTEN})
 same => n,Set(QUEUE_NAME=extgroup_${EXTEN})
 same => n,NoOp(Routing to queue ${QUEUE_NAME})
 same => n,Answer()
 same => n,Set(CHANNEL(musicclass)=default)
 same => n,Queue(${QUEUE_NAME},tTkK,,,300)
 same => n,Hangup()


; =================================================================
; HANGUP HANDLER
; =================================================================
[hangup-handler]
exten => s,1,NoOp(Hangup Handler)
 same => n,Return()

